<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLTN Control Panel v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .status-light { transition: background-color 0.5s ease; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">
    <div class="flex h-screen">
        <nav class="w-20 bg-gray-800 p-4 flex flex-col items-center space-y-6">
            </nav>

        <main class="flex-1 p-8 overflow-y-auto">
            
            <div id="control-page" class="page">
                <h1 class="text-3xl font-bold mb-2">Operator Control Console</h1>
                <p class="text-gray-400 mb-8">Lakukan prosedur startup reaktor secara manual.</p>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-gray-800 p-6 rounded-lg">
                        <h2 class="text-xl font-bold mb-4">Startup Procedure Checklist</h2>
                        <ul class="space-y-4">
                            <li id="step-1" class="flex items-center justify-between"><span class="flex items-center"><span class="status-light w-3 h-3 rounded-full bg-gray-600 mr-3"></span>1. Insert Fuel Rods</span><button id="insert-fuel-btn" class="action-btn bg-blue-600 hover:bg-blue-700 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-bold py-1 px-3 rounded">Execute</button></li>
                            <li id="step-2" class="flex items-center justify-between"><span class="flex items-center"><span class="status-light w-3 h-3 rounded-full bg-gray-600 mr-3"></span>2. Run Coolant System Check</span><button id="coolant-check-btn" class="action-btn bg-blue-600 hover:bg-blue-700 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-bold py-1 px-3 rounded" disabled>Execute</button></li>
                            <li id="step-3" class="flex items-center justify-between"><span class="flex items-center"><span class="status-light w-3 h-3 rounded-full bg-gray-600 mr-3"></span>3. Insert Neutron Source</span><button id="insert-source-btn" class="action-btn bg-blue-600 hover:bg-blue-700 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-bold py-1 px-3 rounded" disabled>Execute</button></li>
                            <li id="step-4" class="flex items-center justify-between"><span class="flex items-center"><span class="status-light w-3 h-3 rounded-full bg-gray-600 mr-3"></span>4. Achieve Criticality (k=1)</span><span class="text-gray-400">Manual Adjust</span></li>
                            <li id="step-5" class="flex items-center justify-between"><span class="flex items-center"><span class="status-light w-3 h-3 rounded-full bg-gray-600 mr-3"></span>5. Power Up to Operational</span><span class="text-gray-400">Manual Adjust</span></li>
                        </ul>
                        <button id="shutdown-btn" class="w-full mt-8 bg-red-600 hover:bg-red-700 disabled:bg-gray-500 text-white font-bold py-2 px-4 rounded" disabled>SHUTDOWN</button>
                    </div>

                    <div class="lg:col-span-2 grid grid-cols-2 gap-8">
                        <div class="col-span-2 bg-gray-800 p-6 rounded-lg flex items-center justify-between">
                            <div>
                               <h2 class="text-lg font-medium text-gray-400">System Status</h2>
                               <p id="status-indicator" class="text-4xl font-black transition-colors">OFFLINE</p>
                            </div>
                            <div>
                               <h2 class="text-lg font-medium text-gray-400 text-right">Reactor State</h2>
                               <p id="reactor-state" class="text-4xl font-bold text-right">--</p>
                            </div>
                        </div>

                        <div class="col-span-2 bg-gray-800 p-6 rounded-lg">
                            <h2 class="text-xl font-bold mb-4">Manual Control Rod</h2>
                            <label for="rod-slider" class="block mb-2">Position (% Extracted): <span id="rod-slider-value" class="font-bold text-xl">0.00</span>%</label>
                            <input id="rod-slider" type="range" min="0" max="100" value="0" step="0.5" class="w-full h-3 bg-gray-700 rounded-lg appearance-none cursor-pointer" disabled>
                        </div>

                        <div class="bg-gray-800 p-4 rounded-lg text-center"><h3 class="text-sm font-medium text-gray-400">Reactivity (k)</h3><p id="reactivity-k" class="text-3xl font-bold">--</p></div>
                        <div class="bg-gray-800 p-4 rounded-lg text-center"><h3 class="text-sm font-medium text-gray-400">Temperature (Â°C)</h3><p id="reactor-temp" class="text-3xl font-bold">--</p></div>
                        <div class="bg-gray-800 p-4 rounded-lg text-center"><h3 class="text-sm font-medium text-gray-400">Power (MW)</h3><p id="power-output" class="text-3xl font-bold">--</p></div>
                        <div class="bg-gray-800 p-4 rounded-lg text-center"><h3 class="text-sm font-medium text-gray-400">Neutron Flux</h3><p id="neutron-flux" class="text-3xl font-bold">--</p></div>
                    </div>
                </div>
            </div>
            
            <div id="analytics-page" class="page hidden"><h1 class="text-3xl font-bold mb-8">Detailed Analytics</h1></div>
            <div id="resources-page" class="page hidden"><h1 class="text-3xl font-bold mb-8">Resources Management</h1></div>
        </main>
    </div>

    <script>
        // --- Referensi Elemen UI ---
        const ui = {
            buttons: {
                insertFuel: document.getElementById('insert-fuel-btn'),
                coolantCheck: document.getElementById('coolant-check-btn'),
                insertSource: document.getElementById('insert-source-btn'),
                shutdown: document.getElementById('shutdown-btn'),
            },
            steps: {
                step1: document.querySelector('#step-1 .status-light'),
                step2: document.querySelector('#step-2 .status-light'),
                step3: document.querySelector('#step-3 .status-light'),
                step4: document.querySelector('#step-4 .status-light'),
                step5: document.querySelector('#step-5 .status-light'),
            },
            displays: {
                statusIndicator: document.getElementById('status-indicator'),
                reactorState: document.getElementById('reactor-state'),
                rodSliderValue: document.getElementById('rod-slider-value'),
                reactivityK: document.getElementById('reactivity-k'),
                reactorTemp: document.getElementById('reactor-temp'),
                powerOutput: document.getElementById('power-output'),
                neutronFlux: document.getElementById('neutron-flux'),
            },
            controls: {
                rodSlider: document.getElementById('rod-slider'),
            }
        };

        // --- Logika API ---
        async function performAction(action, value = null) {
            try {
                const payload = { action };
                if (value !== null) {
                    payload.value = value;
                }
                const response = await fetch('/api/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                console.log(result.message); // Tampilkan feedback di console
            } catch (error) {
                console.error(`Action ${action} failed:`, error);
            }
        }

        // --- Event Listeners ---
        ui.buttons.insertFuel.addEventListener('click', () => performAction('insert_fuel'));
        ui.buttons.coolantCheck.addEventListener('click', () => performAction('run_coolant_check'));
        ui.buttons.insertSource.addEventListener('click', () => performAction('insert_neutron_source'));
        ui.buttons.shutdown.addEventListener('click', () => performAction('shutdown'));
        ui.controls.rodSlider.addEventListener('input', () => {
            const newPosition = ui.controls.rodSlider.value;
            ui.displays.rodSliderValue.innerText = parseFloat(newPosition).toFixed(2);
            performAction('set_rod_position', newPosition);
        });

        // --- Fungsi Update UI Utama ---
        function updateUI(data) {
            // Update Teks
            ui.displays.reactorState.innerText = data.reactor_state;
            ui.displays.reactivityK.innerText = data.reactivity_k.toFixed(4);
            ui.displays.reactorTemp.innerText = data.coolant_temp_celsius.toFixed(2);
            ui.displays.powerOutput.innerText = data.reactor_power_mw.toFixed(4);
            ui.displays.neutronFlux.innerText = data.neutron_flux.toExponential(2);
            ui.displays.rodSliderValue.innerText = data.rod_position.toFixed(2);
            
            // Update Indikator Status
            const indicator = ui.displays.statusIndicator;
            indicator.innerText = data.status_indicator;
            indicator.classList.remove('text-green-400', 'text-yellow-400', 'text-red-500', 'text-gray-500');
            if (data.status_indicator === 'AMAN') indicator.classList.add('text-green-400');
            else if (data.status_indicator === 'RENTAN') indicator.classList.add('text-yellow-400');
            else if (data.status_indicator === 'BERESIKO') indicator.classList.add('text-orange-500');
            else if (data.status_indicator === 'FAILURE') indicator.classList.add('text-red-500', 'animate-pulse');
            else indicator.classList.add('text-gray-500');

            // Logika State Machine untuk Tombol & Slider
            const state = data.reactor_state;
            ui.buttons.insertFuel.disabled = state !== 'COLD_SHUTDOWN';
            ui.buttons.coolantCheck.disabled = state !== 'PRE_STARTUP';
            ui.buttons.insertSource.disabled = state !== 'PRE_STARTUP' || !data.is_coolant_system_ok;
            ui.controls.rodSlider.disabled = !data.is_neutron_source_inserted || state === 'COLD_SHUTDOWN';
            ui.buttons.shutdown.disabled = state === 'COLD_SHUTDOWN' || state === 'SHUTDOWN';

            // Logika State Machine untuk Lampu Indikator Prosedur
            ui.steps.step1.className = 'status-light w-3 h-3 rounded-full mr-3 ' + (data.uranium_kg > 0 ? 'bg-green-500' : 'bg-gray-600');
            ui.steps.step2.className = 'status-light w-3 h-3 rounded-full mr-3 ' + (data.is_coolant_system_ok ? 'bg-green-500' : 'bg-gray-600');
            ui.steps.step3.className = 'status-light w-3 h-3 rounded-full mr-3 ' + (data.is_neutron_source_inserted ? 'bg-green-500' : 'bg-gray-600');
            ui.steps.step4.className = 'status-light w-3 h-3 rounded-full mr-3 ' + (state === 'CRITICAL' || state === 'POWER_UP' || state === 'OPERATIONAL' ? 'bg-green-500' : 'bg-gray-600');
            ui.steps.step5.className = 'status-light w-3 h-3 rounded-full mr-3 ' + (state === 'OPERATIONAL' ? 'bg-green-500' : 'bg-gray-600');
        }

        // --- Loop Utama ---
        async function mainLoop() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error("Failed to fetch status:", error);
            }
        }

        // Halaman default
        // showPage('control-page'); 
        setInterval(mainLoop, 1000);
        mainLoop();
    </script>
</body>
</html>
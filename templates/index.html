<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLTN Control Console v3.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS Kustom */
        @keyframes pulse-green { 0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
        .blinking-startup { animation: pulse-green 2s infinite; }
        .glowing-shutdown { box-shadow: 0 0 8px #EF4444; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4B5563; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #22C55E; }
        input:checked + .slider:before { transform: translateX(22px); }
        input:disabled + .slider { cursor: not-allowed; background-color: #374151 !important; }
        .flow-connector { height: 6px; width: 100%; background-color: #374151; transition: background-color 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans select-none">
    <div class="flex flex-col h-screen">
        <header class="bg-gray-800 p-4 flex justify-between items-center border-b border-gray-700">
            <h1 class="text-2xl font-bold">PLTN Operator Console</h1>
            <div id="status-indicator-wrapper" class="text-right bg-gray-900 p-2 px-4 rounded-lg">
                <p id="status-indicator" class="text-2xl font-black">CONNECTING...</p>
            </div>
        </header>

        <main class="flex-1 p-6 overflow-y-auto">
            <div class="flex justify-center space-x-6 mb-6">
                <button id="startup-btn" class="text-xl font-bold py-3 px-8 rounded-lg">REACTOR STARTUP</button>
                <button id="shutdown-btn" class="text-xl font-bold py-3 px-8 rounded-lg">REACTOR SHUTDOWN</button>
                <button id="scram-btn" class="text-xl font-bold bg-yellow-500 text-black py-3 px-8 rounded-lg">EMERGENCY SCRAM</button>
            </div>

            <div id="procedure-panel" class="flex items-center justify-center p-4 bg-gray-800/50 rounded-lg">
                <div class="bg-gray-800 p-4 rounded-lg w-72 text-center border-2 border-transparent"><div class="flex justify-between items-center mb-2"><h2 class="font-bold">1. COOLANT & MODERATOR</h2><div id="block-1-indicator" class="w-4 h-4 rounded-full bg-gray-600"></div></div><p class="text-sm text-gray-400">Moderator: Dâ‚‚O</p><div class="w-full bg-gray-700 rounded-full h-2.5 my-3"><div id="block-1-progress" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div><div class="mt-3"><label class="switch"><input type="checkbox" id="coolant-switch" disabled><span class="slider"></span></label></div></div>
                <div id="connector-1" class="flow-connector flex-1 max-w-16"></div>
                <div class="bg-gray-800 p-4 rounded-lg w-72 text-center border-2 border-transparent"><div class="flex justify-between items-center mb-2"><h2 class="font-bold">2. ROD SYSTEMS</h2><div id="block-2-indicator" class="w-4 h-4 rounded-full bg-gray-600"></div></div><p class="text-sm text-gray-400">Lowering Rods</p><div class="w-full bg-gray-700 rounded-full h-2.5 my-3"><div id="block-2-progress" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div><div class="mt-3"><label class="switch"><input type="checkbox" id="rods-switch" disabled><span class="slider"></span></label></div></div>
                <div id="connector-2" class="flow-connector flex-1 max-w-16"></div>
                <div class="bg-gray-800 p-4 rounded-lg w-72 text-center border-2 border-transparent"><div class="flex justify-between items-center mb-2"><h2 class="font-bold">3. FISSION REACTION</h2><div id="block-3-indicator" class="w-4 h-4 rounded-full bg-gray-600"></div></div><p class="text-sm text-gray-400">Initiator: Polonium-210</p><div class="w-full bg-gray-700 rounded-full h-2.5 my-3"><div id="block-3-progress" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div><div class="mt-3"><label class="switch"><input type="checkbox" id="initiator-switch" disabled><span class="slider"></span></label></div></div>
            </div>

            <div id="main-control-panel" class="hidden grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-lg"><h2 class="text-xl font-bold">Main Control Rod</h2><label class="block mb-2">Position (% Extracted): <span id="rod-slider-value" class="font-bold text-2xl text-yellow-400">0.00</span>%</label><input id="rod-slider" type="range" min="0" max="100" value="0" step="0.5" class="w-full h-3 rounded-lg appearance-none cursor-pointer" disabled></div>
                <div class="bg-gray-800 p-6 rounded-lg text-center"><h2 class="font-bold">Reactivity (k)</h2><p id="reactivity-k" class="text-5xl font-mono font-bold">0.0000</p></div>
            </div>
        </main>
    </div>

    <script>
    // Menunggu seluruh halaman HTML dimuat sebelum menjalankan script
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- Referensi Elemen UI ---
        const ui = {
            buttons: { startup: document.getElementById('startup-btn'), shutdown: document.getElementById('shutdown-btn'), scram: document.getElementById('scram-btn') },
            indicator: document.getElementById('status-indicator'),
            blocks: {
                b1_indicator: document.getElementById('block-1-indicator'), b2_indicator: document.getElementById('block-2-indicator'), b3_indicator: document.getElementById('block-3-indicator'),
                b1_progress: document.getElementById('block-1-progress'), b2_progress: document.getElementById('block-2-progress'), b3_progress: document.getElementById('block-3-progress'),
            },
            connectors: { c1: document.getElementById('connector-1'), c2: document.getElementById('connector-2') },
            switches: { coolant: document.getElementById('coolant-switch'), rods: document.getElementById('rods-switch'), initiator: document.getElementById('initiator-switch') },
            mainControl: { panel: document.getElementById('main-control-panel'), slider: document.getElementById('rod-slider'), sliderValue: document.getElementById('rod-slider-value'), reactivity: document.getElementById('reactivity-k') }
        };

        // --- Logika API ---
        async function performAction(action, value = null) {
            try {
                const payload = { action, value };
                await fetch('/api/action', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                mainLoop();
            } catch (error) { console.error(`Action ${action} failed:`, error); }
        }

        // --- Event Listeners ---
        ui.buttons.startup.addEventListener('click', () => performAction('begin_startup'));
        ui.buttons.shutdown.addEventListener('click', () => { if(confirm('Confirm gradual reactor shutdown?')) performAction('shutdown'); });
        ui.buttons.scram.addEventListener('click', () => { if(confirm('CONFIRM EMERGENCY SCRAM?')) performAction('scram'); });
        ui.switches.coolant.addEventListener('change', () => { if(ui.switches.coolant.checked) performAction('activate_coolant'); });
        ui.switches.rods.addEventListener('change', () => { if(ui.switches.rods.checked) performAction('lower_rods'); });
        ui.switches.initiator.addEventListener('change', () => { if(ui.switches.initiator.checked) performAction('activate_initiator', 100); });
        ui.mainControl.slider.addEventListener('change', () => performAction('set_rod_position', ui.mainControl.slider.value));
        ui.mainControl.slider.addEventListener('input', () => { ui.mainControl.sliderValue.innerText = parseFloat(ui.mainControl.slider.value).toFixed(2); });

        // --- Fungsi Update UI Utama ---
        function updateUI(data) {
            const state = data.reactor_state;
            
            ui.buttons.startup.disabled = state !== 'OFFLINE';
            ui.buttons.startup.className = state === 'OFFLINE' ? 'text-xl font-bold py-3 px-8 rounded-lg bg-green-600 text-white blinking-startup' : 'text-xl font-bold py-3 px-8 rounded-lg bg-gray-700 text-gray-500 cursor-not-allowed';
            const isOnline = ['MANUAL_CONTROL', 'OPERATIONAL', 'FAILURE'].includes(state);
            ui.buttons.shutdown.disabled = !isOnline;
            ui.buttons.shutdown.className = ui.buttons.shutdown.disabled ? 'text-xl font-bold py-3 px-8 rounded-lg bg-gray-700 text-gray-500 cursor-not-allowed' : 'text-xl font-bold py-3 px-8 rounded-lg bg-red-600 text-white glowing-shutdown';

            ui.indicator.innerText = data.status_indicator || state;
            ui.indicator.classList.remove('text-green-400', 'text-yellow-400', 'text-orange-500', 'text-red-500', 'text-gray-500');
            if (data.status_indicator === 'AMAN') ui.indicator.classList.add('text-green-400');
            else if (data.status_indicator === 'RENTAN') ui.indicator.classList.add('text-yellow-400');
            else if (data.status_indicator === 'BERESIKO') ui.indicator.classList.add('text-orange-500');
            else if (data.status_indicator === 'FAILURE') ui.indicator.classList.add('text-red-500', 'animate-pulse');
            else ui.indicator.classList.add('text-gray-500');

            ui.switches.coolant.disabled = state !== 'AWAITING_COOLANT';
            ui.switches.coolant.checked = data.coolant_on;
            ui.blocks.b1_progress.style.width = data.coolant_on ? '100%' : '0%';
            ui.blocks.b1_indicator.className = data.coolant_on ? 'w-4 h-4 rounded-full bg-green-500' : 'w-4 h-4 rounded-full bg-gray-600';
            
            ui.connectors.c1.style.backgroundColor = data.coolant_on ? '#2563EB' : '#374151';
            ui.switches.rods.disabled = state !== 'AWAITING_RODS';
            ui.switches.rods.checked = data.rods_inserted;
            ui.blocks.b2_progress.style.width = data.rods_inserted ? '100%' : '0%';
            ui.blocks.b2_indicator.className = data.rods_inserted ? 'w-4 h-4 rounded-full bg-green-500' : 'w-4 h-4 rounded-full bg-gray-600';
            
            ui.connectors.c2.style.backgroundColor = data.rods_inserted ? '#2563EB' : '#374151';
            ui.switches.initiator.disabled = state !== 'AWAITING_INITIATOR';
            ui.switches.initiator.checked = data.initiator_on;
            ui.blocks.b3_progress.style.width = data.initiator_on ? '100%' : '0%';
            ui.blocks.b3_indicator.className = data.initiator_on ? 'w-4 h-4 rounded-full bg-green-500' : 'w-4 h-4 rounded-full bg-gray-600';

            const showMainControl = ['MANUAL_CONTROL', 'OPERATIONAL', 'SHUTDOWN', 'FAILURE'].includes(state);
            ui.mainControl.panel.style.display = showMainControl ? 'grid' : 'none';
            ui.mainControl.slider.disabled = !showMainControl;
            if (document.activeElement !== ui.mainControl.slider) {
                ui.mainControl.slider.value = data.rod_position;
                ui.mainControl.sliderValue.innerText = data.rod_position.toFixed(2);
            }
            ui.mainControl.reactivity.innerText = data.reactivity_k.toFixed(4);
        }

        // --- Loop Utama ---
        async function mainLoop() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateUI(data);
            } catch (error) { console.error("Failed to fetch status:", error); }
        }

        setInterval(mainLoop, 1000);
        mainLoop();
    });
    </script>
</body>
</html>